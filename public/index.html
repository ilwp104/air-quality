<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•œêµ­ ë¯¸ì„¸ë¨¼ì§€ ì‹¤ì‹œê°„ í˜„í™©</title>
  <meta name="google-adsense-account" content="ca-pub-2601124884291683">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2601124884291683" crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh; padding: 40px 20px; color: #e0e0e0;
    }
    .container { max-width: 960px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 36px; }
    header h1 { font-size: 2.2rem; color: #fff; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    header .subtitle { color: rgba(255,255,255,0.7); font-size: 0.95rem; }
    .status-bar { display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 12px; flex-wrap: wrap; }
    .status-bar .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
    .badge-live { background: rgba(76,175,80,0.2); color: #81c784; border: 1px solid rgba(76,175,80,0.3); }
    .badge-live .dot { width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .badge-time { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.15); }
    .badge-src { background: rgba(0,150,136,0.15); color: #80cbc4; border: 1px solid rgba(0,150,136,0.25); }
    .badge-refresh { background: rgba(100,181,246,0.15); color: #90caf9; border: 1px solid rgba(100,181,246,0.25); cursor: pointer; transition: all 0.2s; }
    .badge-refresh:hover { background: rgba(100,181,246,0.3); }
    .badge-refresh.spinning .ri { animation: spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

    .card { background: rgba(255,255,255,0.06); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 28px 32px; margin-bottom: 20px; }
    .card h2 { font-size: 1.15rem; margin-bottom: 20px; color: #fff; display: flex; align-items: center; gap: 8px; }
    .card h2 .h2-sub { font-size: 0.75rem; font-weight: 400; opacity: 0.5; }

    /* â”€â”€â”€ í–‰ì •êµ¬ì—­ ì§€ë„ â”€â”€â”€ */
    #district-map-svg { width: 100%; background: rgba(255,255,255,0.03); border-radius: 12px; }
    #district-map-svg .district { stroke: rgba(255,255,255,0.3); stroke-width: 0.5px; cursor: pointer; transition: opacity 0.15s; }
    #district-map-svg .district:hover { opacity: 0.8; stroke: #fff; stroke-width: 1.5px; }
    #district-map-svg .district-label { fill: rgba(0,0,0,0.7); font-size: 9px; font-weight: 700; pointer-events: none; text-anchor: middle; }
    #district-map-svg .district-val { fill: rgba(0,0,0,0.5); font-size: 7px; font-weight: 600; pointer-events: none; text-anchor: middle; }

    .map-loading { text-align: center; padding: 60px; color: rgba(255,255,255,0.4); }
    .map-loading .sp { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.15); border-top-color: #90caf9; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }

    /* ë²”ë¡€ */
    .legend { display: flex; justify-content: center; gap: 16px; margin-top: 14px; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: rgba(255,255,255,0.6); }
    .legend-color { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.2); }

    /* íˆ´íŒ */
    .map-tooltip {
      position: fixed; pointer-events: none; z-index: 100;
      background: #1e293b; border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px; padding: 12px 16px; font-size: 0.82rem;
      color: #e0e0e0; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      display: none; max-width: 220px; line-height: 1.6;
    }
    .map-tooltip .tt-name { font-weight: 700; color: #fff; font-size: 0.95rem; margin-bottom: 4px; }
    .map-tooltip .tt-badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-weight: 700; color: #fff; font-size: 0.72rem; }

    /* ìš”ì•½ ë°” */
    .my-summary { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding: 20px 24px; border-radius: 14px; flex-wrap: wrap; }
    .my-summary .s-icon { width: 52px; height: 52px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; flex-shrink: 0; background: rgba(255,255,255,0.15); }
    .my-summary .s-info { flex: 1; min-width: 140px; }
    .my-summary .s-region { font-weight: 800; font-size: 1.2rem; }
    .my-summary .s-station { font-size: 0.75rem; opacity: 0.7; margin-top: 2px; }
    .my-summary .s-time { font-size: 0.65rem; opacity: 0.5; margin-top: 2px; }
    .my-summary .s-grade { text-align: center; min-width: 90px; }
    .my-summary .s-grade .gv { font-size: 2.6rem; font-weight: 800; line-height: 1; }
    .my-summary .s-grade .gl { font-size: 0.85rem; font-weight: 600; margin-top: 4px; }
    .my-summary .s-data { display: flex; gap: 14px; }
    .my-summary .sd { text-align: center; }
    .my-summary .sd .sl { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; opacity: 0.6; }
    .my-summary .sd .sv { font-size: 1.15rem; font-weight: 700; margin-top: 2px; }

    /* ë‚ ì”¨ í–‰ */
    .weather-row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      padding: 16px 20px;
      margin-bottom: 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .weather-row .w-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      min-width: 70px;
    }
    .weather-row .w-icon { font-size: 1.2rem; }
    .weather-row .w-val { font-weight: 700; color: #fff; font-size: 0.95rem; }
    .weather-row .w-lbl { font-size: 0.6rem; opacity: 0.5; }
    .weather-row .w-time { font-size: 0.65rem; opacity: 0.4; margin-left: auto; align-self: center; }

    /* â”€â”€â”€ ë„ì‹œ ê·¸ë¦¬ë“œ â”€â”€â”€ */
    .city-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 14px; }
    .city-card { border-radius: 14px; padding: 20px; text-align: center; transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; }
    .city-card:hover { transform: translateY(-4px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .city-card .c-name { font-size: 1rem; font-weight: 700; margin-bottom: 2px; }
    .city-card .c-station { font-size: 0.7rem; opacity: 0.6; margin-bottom: 10px; }
    .city-card .c-val { font-size: 2.4rem; font-weight: 800; line-height: 1; margin-bottom: 6px; }
    .city-card .c-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 10px; }
    .city-card .c-data { display: flex; justify-content: center; gap: 12px; font-size: 0.75rem; opacity: 0.8; }
    .city-card .c-data span { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .city-card .c-data .lb { font-weight: 600; font-size: 0.65rem; text-transform: uppercase; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .city-card { animation: fadeIn 0.4s ease-out; }

    /* ë“±ê¸‰ ìƒ‰ìƒ */
    .gr-good { background: linear-gradient(135deg, #1b5e20, #2e7d32); color: #c8e6c9; }
    .gr-good .c-val,.gr-good .c-name,.gr-good .gv,.gr-good .s-region { color: #e8f5e9; }
    .gr-mod { background: linear-gradient(135deg, #0277bd, #0288d1); color: #b3e5fc; }
    .gr-mod .c-val,.gr-mod .c-name,.gr-mod .gv,.gr-mod .s-region { color: #e1f5fe; }
    .gr-bad { background: linear-gradient(135deg, #e65100, #f57c00); color: #fff3e0; }
    .gr-bad .c-val,.gr-bad .c-name,.gr-bad .gv,.gr-bad .s-region { color: #fff8e1; }
    .gr-vbad { background: linear-gradient(135deg, #b71c1c, #c62828); color: #ffcdd2; }
    .gr-vbad .c-val,.gr-vbad .c-name,.gr-vbad .gv,.gr-vbad .s-region { color: #ffebee; }
    .gr-load { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.4); }

    /* ë“±ê¸‰ í…Œì´ë¸” */
    .grade-table { width: 100%; border-collapse: collapse; }
    .grade-table th,.grade-table td { padding: 12px 16px; text-align: center; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .grade-table th { color: rgba(255,255,255,0.5); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .grade-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
    .dot-good { background: #4caf50; } .dot-mod { background: #0288d1; } .dot-bad { background: #ff9800; } .dot-vbad { background: #f44336; }

    /* ë§í¬ */
    .links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .links a { display: block; padding: 14px 20px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; text-decoration: none; color: #ccc; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; }
    .links a:hover { background: rgba(102,126,234,0.3); border-color: rgba(102,126,234,0.5); color: #fff; transform: translateY(-2px); }
    .links a small { display: block; font-size: 0.72rem; opacity: 0.6; margin-top: 4px; }

    /* ê´‘ê³  */
    .ad-container { margin: 20px 0; text-align: center; min-height: 90px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border-radius: 12px; overflow: hidden; }
    .ad-container ins { width: 100%; }

    footer { text-align: center; margin-top: 32px; color: rgba(255,255,255,0.4); font-size: 0.75rem; line-height: 1.8; }
    footer a { color: rgba(255,255,255,0.5); }

    /* â”€â”€â”€ ì§€ì—­ ì„ íƒ ì˜¤ë²„ë ˆì´ â”€â”€â”€ */
    .region-overlay {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
      display: none; align-items: center; justify-content: center;
    }
    .region-overlay.open { display: flex; }
    .region-panel {
      background: #1e293b; border: 1px solid rgba(255,255,255,0.15);
      border-radius: 18px; padding: 28px 32px; width: 420px; max-width: 92vw;
      box-shadow: 0 12px 48px rgba(0,0,0,0.6);
      animation: fadeIn 0.2s ease-out;
    }
    .region-panel h3 {
      color: #fff; font-size: 1.1rem; margin-bottom: 6px;
      display: flex; align-items: center; gap: 8px;
    }
    .region-panel .rp-sub { font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-bottom: 18px; }
    .region-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    }
    .region-btn {
      padding: 12px 0; border: 1px solid rgba(255,255,255,0.12); border-radius: 10px;
      background: rgba(255,255,255,0.06); color: #e0e0e0;
      font-size: 0.9rem; font-weight: 600; cursor: pointer;
      transition: all 0.15s;
    }
    .region-btn:hover {
      background: rgba(100,181,246,0.25); border-color: rgba(100,181,246,0.5); color: #fff;
      transform: translateY(-2px);
    }
    .region-btn.active {
      background: rgba(100,181,246,0.35); border-color: #64b5f6; color: #fff;
    }
    .region-close {
      display: block; margin: 16px auto 0; padding: 8px 28px;
      border: 1px solid rgba(255,255,255,0.15); border-radius: 8px;
      background: transparent; color: rgba(255,255,255,0.5); font-size: 0.8rem;
      cursor: pointer; transition: all 0.15s;
    }
    .region-close:hover { background: rgba(255,255,255,0.1); color: #fff; }

    @media (max-width: 600px) {
      body { padding: 20px 12px; } .card { padding: 20px 16px; } header h1 { font-size: 1.6rem; }
      .city-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .city-card { padding: 14px 10px; } .city-card .c-val { font-size: 1.8rem; }
      .my-summary { flex-direction: column; text-align: center; }
      .my-summary .s-data { justify-content: center; }
      #district-map-svg .district-label { font-size: 7px; }
      #district-map-svg .district-val { font-size: 6px; }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>í•œêµ­ ë¯¸ì„¸ë¨¼ì§€ ì‹¤ì‹œê°„ í˜„í™©</h1>
    <p class="subtitle">ì—ì–´ì½”ë¦¬ì•„ ê³µì‹ ë°ì´í„° ê¸°ë°˜ ì‹¤ì‹œê°„ ëŒ€ê¸°ì§ˆ ëª¨ë‹ˆí„°ë§</p>
    <div class="status-bar">
      <span class="badge badge-live"><span class="dot"></span> ì‹¤ì‹œê°„</span>
      <span class="badge badge-src">ì—ì–´ì½”ë¦¬ì•„ (í™˜ê²½ë¶€)</span>
      <span class="badge badge-time" id="update-time">ì—…ë°ì´íŠ¸ ì¤‘...</span>
      <span class="badge badge-refresh" id="refresh-btn" title="ìƒˆë¡œê³ ì¹¨"><span class="ri">&#x21bb;</span> ìƒˆë¡œê³ ì¹¨</span>
    </div>
  </header>

  <!-- ë‚´ ì§€ì—­ í–‰ì •êµ¬ì—­ ì§€ë„ -->
  <div class="card">
    <h2>&#x1F4CD; ë‚´ ì§€ì—­ ëŒ€ê¸°ì§ˆ <span class="h2-sub" id="region-label">ìœ„ì¹˜ í™•ì¸ ì¤‘...</span></h2>
    <div id="my-summary-container">
      <div class="map-loading"><span class="sp"></span>ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div id="weather-container"></div>
    <div id="district-map-container">
      <div class="map-loading"><span class="sp"></span>í–‰ì •êµ¬ì—­ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div class="legend" id="map-legend" style="display:none">
      <div class="legend-item"><div class="legend-color" style="background:#4caf50"></div>ì¢‹ìŒ (0~15)</div>
      <div class="legend-item"><div class="legend-color" style="background:#2196f3"></div>ë³´í†µ (16~35)</div>
      <div class="legend-item"><div class="legend-color" style="background:#ff9800"></div>ë‚˜ì¨ (36~75)</div>
      <div class="legend-item"><div class="legend-color" style="background:#f44336"></div>ë§¤ìš°ë‚˜ì¨ (76+)</div>
      <div class="legend-item"><div class="legend-color" style="background:#bdbdbd"></div>ë°ì´í„° ì—†ìŒ</div>
      <div class="legend-item" style="opacity:0.5">* = PM10 ê¸°ì¤€</div>
    </div>
  </div>

  <!-- ì£¼ìš” ë„ì‹œ -->
  <div class="card">
    <h2>ì£¼ìš” ë„ì‹œ ëŒ€ê¸°ì§ˆ</h2>
    <div class="city-grid" id="city-grid"></div>
  </div>

  <!-- ë“±ê¸‰ ì•ˆë‚´ -->
  <div class="card">
    <h2>í•œêµ­ ëŒ€ê¸°ì§ˆ ë“±ê¸‰ ê¸°ì¤€</h2>
    <table class="grade-table">
      <thead><tr><th>ë“±ê¸‰</th><th>PM2.5 (&#13197;/&#13221;)</th><th>PM10 (&#13197;/&#13221;)</th><th>í–‰ë™ ìš”ë ¹</th></tr></thead>
      <tbody>
        <tr><td><span class="grade-dot dot-good"></span>ì¢‹ìŒ</td><td>0 ~ 15</td><td>0 ~ 30</td><td>ì•¼ì™¸í™œë™ ì í•©</td></tr>
        <tr><td><span class="grade-dot dot-mod"></span>ë³´í†µ</td><td>16 ~ 35</td><td>31 ~ 80</td><td>ë¯¼ê°êµ° ì¥ì‹œê°„ ì•¼ì™¸í™œë™ ì£¼ì˜</td></tr>
        <tr><td><span class="grade-dot dot-bad"></span>ë‚˜ì¨</td><td>36 ~ 75</td><td>81 ~ 150</td><td>ì•¼ì™¸í™œë™ ìì œ, ë§ˆìŠ¤í¬ ì°©ìš©</td></tr>
        <tr><td><span class="grade-dot dot-vbad"></span>ë§¤ìš°ë‚˜ì¨</td><td>76 ì´ìƒ</td><td>151 ì´ìƒ</td><td>ì‹¤ì™¸í™œë™ ê¸ˆì§€</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ì°¸ê³  ì‚¬ì´íŠ¸ -->
  <div class="card">
    <h2>ì°¸ê³  ì‚¬ì´íŠ¸</h2>
    <div class="links">
      <a href="https://www.airkorea.or.kr/web/" target="_blank" rel="noopener">ì—ì–´ì½”ë¦¬ì•„<small>í™˜ê²½ë¶€ ì‹¤ì‹œê°„ ëŒ€ê¸°ì§ˆ</small></a>
      <a href="https://cleanair.seoul.go.kr/" target="_blank" rel="noopener">ì„œìš¸ì‹œ ëŒ€ê¸°í™˜ê²½ì •ë³´<small>ì„œìš¸ ì§€ì—­ ìƒì„¸ ë°ì´í„°</small></a>
      <a href="https://www.airkorea.or.kr/web/dustForecast" target="_blank" rel="noopener">ëŒ€ê¸°ì§ˆ ì˜ˆë³´<small>ì˜¤ëŠ˜/ë‚´ì¼/ëª¨ë ˆ ì˜ˆë³´</small></a>
      <a href="https://www.data.go.kr/tcs/dss/selectApiDataDetailView.do?publicDataPk=15073861" target="_blank" rel="noopener">ê³µê³µë°ì´í„°í¬í„¸<small>ì—ì–´ì½”ë¦¬ì•„ API</small></a>
    </div>
  </div>

  <!-- í•˜ë‹¨ ê´‘ê³  -->
  <div class="ad-container">
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2601124884291683" data-ad-slot="auto" data-ad-format="auto" data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <footer>
    <p>ë°ì´í„° ì¶œì²˜: í•œêµ­í™˜ê²½ê³µë‹¨ ì—ì–´ì½”ë¦¬ì•„ (í™˜ê²½ë¶€) | <a href="https://www.airkorea.or.kr" target="_blank">airkorea.or.kr</a></p>
    <p>1ì‹œê°„ë§ˆë‹¤ ìë™ ê°±ì‹ </p>
  </footer>
</div>

<!-- íˆ´íŒ -->
<div class="map-tooltip" id="tooltip"></div>

<!-- ì§€ì—­ ì„ íƒ ì˜¤ë²„ë ˆì´ -->
<div class="region-overlay" id="region-overlay">
  <div class="region-panel">
    <h3>&#x1F4CD; ì§€ì—­ ì„ íƒ</h3>
    <div class="rp-sub">í…ŒìŠ¤íŠ¸ìš© - F1 ë‘ ë²ˆ ëˆŒëŸ¬ ì—´ê¸° / ESCë¡œ ë‹«ê¸°</div>
    <div class="region-grid" id="region-grid"></div>
    <button class="region-close" id="region-close-btn">ë‹«ê¸° (ESC)</button>
  </div>
</div>

<script>
// â”€â”€â”€ ì„¤ì • â”€â”€â”€
const REFRESH_INTERVAL = 60 * 60 * 1000;
let userSido = null;
let topoData = null;
let currentStations = [];
let stationAddrMap = {}; // stationName â†’ TopoJSON district name

const CITIES = [
  { name: 'ì„œìš¸', sido: 'ì„œìš¸' }, { name: 'ë¶€ì‚°', sido: 'ë¶€ì‚°' },
  { name: 'ì¸ì²œ', sido: 'ì¸ì²œ' }, { name: 'ëŒ€êµ¬', sido: 'ëŒ€êµ¬' },
  { name: 'ëŒ€ì „', sido: 'ëŒ€ì „' }, { name: 'ê´‘ì£¼', sido: 'ê´‘ì£¼' },
  { name: 'ìš¸ì‚°', sido: 'ìš¸ì‚°' }, { name: 'ì„¸ì¢…', sido: 'ì„¸ì¢…' },
  { name: 'ìˆ˜ì›', sido: 'ê²½ê¸°', filter: 'ìˆ˜ì›' },
  { name: 'ì œì£¼', sido: 'ì œì£¼' },
  { name: 'ì°½ì›', sido: 'ê²½ë‚¨', filter: 'ì°½ì›' },
  { name: 'ì²­ì£¼', sido: 'ì¶©ë¶', filter: 'ì²­ì£¼' },
];

const STATE_MAP = {
  'ì„œìš¸íŠ¹ë³„ì‹œ':'ì„œìš¸','ë¶€ì‚°ê´‘ì—­ì‹œ':'ë¶€ì‚°','ëŒ€êµ¬ê´‘ì—­ì‹œ':'ëŒ€êµ¬','ì¸ì²œê´‘ì—­ì‹œ':'ì¸ì²œ',
  'ê´‘ì£¼ê´‘ì—­ì‹œ':'ê´‘ì£¼','ëŒ€ì „ê´‘ì—­ì‹œ':'ëŒ€ì „','ìš¸ì‚°ê´‘ì—­ì‹œ':'ìš¸ì‚°','ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ':'ì„¸ì¢…',
  'ê²½ê¸°ë„':'ê²½ê¸°','ê°•ì›íŠ¹ë³„ìì¹˜ë„':'ê°•ì›','ê°•ì›ë„':'ê°•ì›','ì¶©ì²­ë¶ë„':'ì¶©ë¶',
  'ì¶©ì²­ë‚¨ë„':'ì¶©ë‚¨','ì „ë¶íŠ¹ë³„ìì¹˜ë„':'ì „ë¶','ì „ë¼ë¶ë„':'ì „ë¶','ì „ë¼ë‚¨ë„':'ì „ë‚¨',
  'ê²½ìƒë¶ë„':'ê²½ë¶','ê²½ìƒë‚¨ë„':'ê²½ë‚¨','ì œì£¼íŠ¹ë³„ìì¹˜ë„':'ì œì£¼',
};

// ì‹œë„ëª… â†’ TopoJSON í†µê³„ì²­ ì½”ë“œ ì•2ìë¦¬
const SIDO_CODES = {
  'ì„œìš¸':'11','ë¶€ì‚°':'21','ëŒ€êµ¬':'22','ì¸ì²œ':'23','ê´‘ì£¼':'24','ëŒ€ì „':'25',
  'ìš¸ì‚°':'26','ì„¸ì¢…':'29','ê²½ê¸°':'31','ê°•ì›':'32','ì¶©ë¶':'33','ì¶©ë‚¨':'34',
  'ì „ë¶':'35','ì „ë‚¨':'36','ê²½ë¶':'37','ê²½ë‚¨':'38','ì œì£¼':'39',
};

const SIDO_CENTERS = [
  {name:'ì„œìš¸',lat:37.5665,lng:126.978},{name:'ë¶€ì‚°',lat:35.1796,lng:129.0756},
  {name:'ëŒ€êµ¬',lat:35.8714,lng:128.6014},{name:'ì¸ì²œ',lat:37.4563,lng:126.7052},
  {name:'ê´‘ì£¼',lat:35.1595,lng:126.8526},{name:'ëŒ€ì „',lat:36.3504,lng:127.3845},
  {name:'ìš¸ì‚°',lat:35.5384,lng:129.3114},{name:'ì„¸ì¢…',lat:36.48,lng:127.289},
  {name:'ê²½ê¸°',lat:37.275,lng:127.0094},{name:'ê°•ì›',lat:37.8228,lng:128.1555},
  {name:'ì¶©ë¶',lat:36.6357,lng:127.4913},{name:'ì¶©ë‚¨',lat:36.5184,lng:126.8},
  {name:'ì „ë¶',lat:35.7175,lng:127.153},{name:'ì „ë‚¨',lat:34.8679,lng:126.991},
  {name:'ê²½ë¶',lat:36.4919,lng:128.8889},{name:'ê²½ë‚¨',lat:35.4606,lng:128.2132},
  {name:'ì œì£¼',lat:33.4996,lng:126.5312},
];

// â”€â”€â”€ ë“±ê¸‰ ìœ í‹¸ â”€â”€â”€
function gradeInfo(g) {
  switch(String(g)){
    case '1': return {label:'ì¢‹ìŒ',cls:'gr-good',color:'#4caf50'};
    case '2': return {label:'ë³´í†µ',cls:'gr-mod',color:'#2196f3'};
    case '3': return {label:'ë‚˜ì¨',cls:'gr-bad',color:'#ff9800'};
    case '4': return {label:'ë§¤ìš°ë‚˜ì¨',cls:'gr-vbad',color:'#f44336'};
    default:  return {label:'-',cls:'gr-load',color:'#bdbdbd'};
  }
}

function pm25Color(val) {
  const n = parseInt(val);
  if (isNaN(n)) return '#bdbdbd';
  if (n <= 15) return '#4caf50';
  if (n <= 35) return '#2196f3';
  if (n <= 75) return '#ff9800';
  return '#f44336';
}

function pm10Color(val) {
  const n = parseInt(val);
  if (isNaN(n)) return '#bdbdbd';
  if (n <= 30) return '#4caf50';
  if (n <= 80) return '#2196f3';
  if (n <= 150) return '#ff9800';
  return '#f44336';
}

function pm25ToGrade(val) {
  const n = parseInt(val);
  if (isNaN(n)) return gradeInfo(null);
  if (n <= 15) return gradeInfo('1');
  if (n <= 35) return gradeInfo('2');
  if (n <= 75) return gradeInfo('3');
  return gradeInfo('4');
}

function pm10ToGrade(val) {
  const n = parseInt(val);
  if (isNaN(n)) return gradeInfo(null);
  if (n <= 30) return gradeInfo('1');
  if (n <= 80) return gradeInfo('2');
  if (n <= 150) return gradeInfo('3');
  return gradeInfo('4');
}

// ì¸¡ì •ì†Œì˜ ëŒ€í‘œ ìƒ‰ìƒ: stationGradeì™€ ë™ì¼ ë¡œì§ ì‚¬ìš©
function stationColor(st) {
  return stationGrade(st).color;
}

function stationGrade(st) {
  if (st.pm25Grade) return gradeInfo(st.pm25Grade);
  if (st.pm25Value && st.pm25Value !== '-') return pm25ToGrade(st.pm25Value);
  if (st.pm10Grade) return gradeInfo(st.pm10Grade);
  if (st.pm10Value && st.pm10Value !== '-') return pm10ToGrade(st.pm10Value);
  return gradeInfo(null);
}

// ì¸¡ì •ì†Œì˜ ëŒ€í‘œ ìˆ˜ì¹˜ (í‘œì‹œìš©)
function stationMainValue(st) {
  if (st.pm25Value && st.pm25Value !== '-') return st.pm25Value;
  if (st.pm10Value && st.pm10Value !== '-') return st.pm10Value;
  return '';
}

function stationMainLabel(st) {
  if (st.pm25Value && st.pm25Value !== '-') return 'PM2.5';
  if (st.pm10Value && st.pm10Value !== '-') return 'PM10';
  return '';
}

function vv(x) { return (!x || x === '-') ? '-' : x; }

function findNearestSido(lat, lng) {
  let min = Infinity, r = 'ì„œìš¸';
  SIDO_CENTERS.forEach(s => { const d = (s.lat-lat)**2+(s.lng-lng)**2; if(d<min){min=d;r=s.name;} });
  return r;
}

function pickStation(items, filter) {
  if (!items?.length) return null;
  let f = filter ? items.filter(i => i.stationName?.includes(filter)) : items;
  if (!f.length) f = items;
  return f.find(i => i.pm25Value && i.pm25Value !== '-') || f[0];
}

// â”€â”€â”€ ì—­ì§€ì˜¤ì½”ë”© â”€â”€â”€
async function reverseGeocode(lat, lng) {
  const headers = { 'User-Agent': 'AirQualityDashboard/1.0' };
  try {
    // ìƒì„¸ ì£¼ì†Œ (ë™ ë‹¨ìœ„)
    const res1 = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ko`, { headers });
    const j1 = await res1.json();

    let state = j1.address?.state || j1.address?.province || '';
    const city = j1.address?.city || j1.address?.county || j1.address?.town || '';

    // stateê°€ ì—†ìœ¼ë©´ zoom=8ë¡œ ë„/ê´‘ì—­ì‹œ ë ˆë²¨ ì¬ì¡°íšŒ
    if (!state || !STATE_MAP[state]) {
      const res2 = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ko&zoom=8`, { headers });
      const j2 = await res2.json();
      state = j2.address?.state || j2.address?.province || state;
    }

    return { state, city, sido: STATE_MAP[state] || null };
  } catch { return { state:'', city:'', sido:null }; }
}

// â”€â”€â”€ API â”€â”€â”€
async function fetchBulkSido(sidoNames) {
  const unique = [...new Set(sidoNames)];
  const res = await fetch(`/api/realtime-bulk?sido=${unique.join(',')}`);
  if (!res.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
  return res.json();
}

// â”€â”€â”€ ì¸¡ì •ì†Œ ì£¼ì†Œ â†’ í–‰ì •êµ¬ì—­ ë§¤í•‘ êµ¬ì¶• â”€â”€â”€
function parseDistrictFromAddr(addr) {
  const parts = addr.split(/\s+/);
  let city = '', gu = '';
  for (const p of parts) {
    if ((p.endsWith('ì‹œ') || p.endsWith('êµ°')) && p.length > 1
        && !p.includes('íŠ¹ë³„') && !p.includes('ê´‘ì—­')) {
      city = p;
    } else if (p.endsWith('êµ¬') && city.endsWith('ì‹œ') && p.length > 1) {
      gu = p;
      break;
    }
  }
  return { full: city + gu, city };
}

async function buildStationAddrMap(sido, districtNames) {
  try {
    const res = await fetch(`/api/station-list/${encodeURIComponent(sido)}`);
    const list = await res.json();
    if (!Array.isArray(list) || list.length === 0) return;

    const map = {};
    for (const st of list) {
      const addr = st.addr || '';
      const stName = st.stationName || '';
      if (!addr || !stName) continue;

      const { full, city } = parseDistrictFromAddr(addr);

      // 1) ì‹œ+êµ¬ ì „ì²´ ë§¤ì¹˜ (ìˆ˜ì›ì‹œì¥ì•ˆêµ¬)
      if (full && districtNames.includes(full)) {
        map[stName] = full;
      }
      // 2) ì‹œë§Œ ë§¤ì¹˜ (ë¶€ì²œì‹œ) - í•´ë‹¹ ì‹œ+êµ¬ê°€ TopoJSONì— ì—†ì„ ë•Œ
      else if (city && districtNames.includes(city)) {
        map[stName] = city;
      }
      // 3) êµ¬ë§Œ ë§¤ì¹˜ (ì„œìš¸ ì¢…ë¡œêµ¬ ë“± - ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ)
      else {
        for (const p of addr.split(/\s+/)) {
          if (p.endsWith('êµ¬') && p.length > 1 && districtNames.includes(p)) {
            map[stName] = p;
            break;
          }
        }
      }
    }
    Object.assign(stationAddrMap, map);
    console.log(`ì¸¡ì •ì†Œ ì£¼ì†Œ ë§¤í•‘ ì™„ë£Œ: ${Object.keys(stationAddrMap).length}ê°œ ì¸¡ì •ì†Œ`);
  } catch (e) {
    console.error('ì¸¡ì •ì†Œ ì£¼ì†Œ ë§¤í•‘ ì‹¤íŒ¨:', e);
  }
}

// â”€â”€â”€ ì¸¡ì •ì†Œ â†’ í–‰ì •êµ¬ì—­ ë§¤ì¹­ â”€â”€â”€
function matchStationToDistrict(districtName, stations) {
  // 0) ë‹¨ì¼ í–‰ì •êµ¬ì—­ (ì„¸ì¢… ë“±) - ëª¨ë“  ì¸¡ì •ì†Œê°€ í•´ë‹¹ êµ¬ì—­ì´ë¯€ë¡œ ëŒ€í‘œ ì¸¡ì •ì†Œ ë°˜í™˜
  if (stations.length > 0 && districtName.includes('ì„¸ì¢…')) {
    return stations.find(st => st.pm25Value && st.pm25Value !== '-')
      || stations.find(st => st.pm10Value && st.pm10Value !== '-')
      || stations[0];
  }

  // 1) ì£¼ì†Œ ê¸°ë°˜ ë§¤ì¹­ (ê°€ì¥ ì •í™•)
  const addrMatched = stations.filter(st => stationAddrMap[st.stationName] === districtName);
  if (addrMatched.length > 0) {
    // PM2.5 ë°ì´í„° ìˆëŠ” ì¸¡ì •ì†Œ ìš°ì„ , ì—†ìœ¼ë©´ PM10ì´ë¼ë„ ìˆëŠ” ê²ƒ, ìµœí›„ì—” ì•„ë¬´ê±°ë‚˜
    return addrMatched.find(st => st.pm25Value && st.pm25Value !== '-')
      || addrMatched.find(st => st.pm10Value && st.pm10Value !== '-')
      || addrMatched[0];
  }

  // 2) ì´ë¦„ ê¸°ë°˜ í´ë°±
  const clean = districtName.replace(/íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„|ë„$/g, '').trim();
  const parts = clean.replace(/ì‹œ$|êµ°$|êµ¬$/g, '').trim();

  for (const st of stations) {
    const sn = st.stationName || '';
    if (clean.includes(sn) || sn.includes(parts)) return st;
  }

  const prefix = parts.slice(0, 2);
  if (prefix.length >= 2) {
    for (const st of stations) {
      if (st.stationName?.includes(prefix)) return st;
    }
  }

  return null;
}

// â”€â”€â”€ D3 í–‰ì •êµ¬ì—­ ì§€ë„ ë Œë”ë§ â”€â”€â”€
function renderDistrictMap(sido, stations) {
  const container = document.getElementById('district-map-container');
  if (!topoData) {
    container.innerHTML = '<div class="map-loading">ì§€ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const objectName = Object.keys(topoData.objects)[0];
  const allFeatures = topojson.feature(topoData, topoData.objects[objectName]).features;

  const sidoCode = SIDO_CODES[sido];
  if (!sidoCode) {
    container.innerHTML = '<div class="map-loading">í•´ë‹¹ ì§€ì—­ ì§€ë„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const features = allFeatures.filter(f => {
    const code = String(f.properties.code || f.properties.SIG_CD || f.properties.adm_cd || '');
    return code.startsWith(sidoCode);
  });

  if (features.length === 0) {
    container.innerHTML = '<div class="map-loading">í•´ë‹¹ ì§€ì—­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  container.innerHTML = '';
  document.getElementById('map-legend').style.display = 'flex';

  const width = Math.min(container.clientWidth || 896, 896);
  const height = Math.max(400, width * 0.7);

  const svg = d3.select(container)
    .append('svg')
    .attr('id', 'district-map-svg')
    .attr('viewBox', `0 0 ${width} ${height}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const fc = { type: 'FeatureCollection', features };
  const projection = d3.geoMercator().fitSize([width - 40, height - 40], fc);
  // ë‹¨ì¼ í–‰ì •êµ¬ì—­(ì„¸ì¢… ë“±)ì¼ ë•Œ ê³¼ë„í•œ í™•ëŒ€ ë°©ì§€
  if (features.length <= 2) {
    const maxScale = 30000;
    if (projection.scale() > maxScale) projection.scale(maxScale);
    // ì¤‘ì‹¬ ì¬ì„¤ì •
    const cent = d3.geoCentroid(fc);
    projection.center(cent).translate([width / 2, height / 2]);
  } else {
    projection.translate([projection.translate()[0] + 20, projection.translate()[1] + 20]);
  }
  const pathGen = d3.geoPath().projection(projection);

  const tooltip = document.getElementById('tooltip');

  // ì§€ë„ ê·¸ë¦¬ê¸°
  svg.selectAll('.district')
    .data(features)
    .enter()
    .append('path')
    .attr('class', 'district')
    .attr('d', pathGen)
    .attr('fill', d => {
      const name = d.properties.name || d.properties.SIG_KOR_NM || '';
      const st = matchStationToDistrict(name, stations);
      return st ? stationColor(st) : '#bdbdbd';
    })
    .on('mousemove', (event, d) => {
      const name = d.properties.name || d.properties.SIG_KOR_NM || '';
      const st = matchStationToDistrict(name, stations);
      let html = `<div class="tt-name">${name}</div>`;
      if (st) {
        const info = stationGrade(st);
        const mainLbl = stationMainLabel(st);
        html += `<span class="tt-badge" style="background:${info.color}">${info.label}</span>`;
        if (mainLbl) html += ` <span style="opacity:0.5;font-size:0.72rem">(${mainLbl} ê¸°ì¤€)</span>`;
        html += '<br>';
        html += `PM2.5: <strong>${vv(st.pm25Value)}</strong> | PM10: <strong>${vv(st.pm10Value)}</strong><br>`;
        html += `O3: ${vv(st.o3Value)} | NO2: ${vv(st.no2Value)}<br>`;
        html += `<span style="opacity:0.5;font-size:0.72rem">${st.stationName} ì¸¡ì •ì†Œ</span>`;
      } else {
        html += '<span style="opacity:0.5">ì¸¡ì • ë°ì´í„° ì—†ìŒ</span>';
      }
      tooltip.innerHTML = html;
      tooltip.style.display = 'block';
      tooltip.style.left = (event.clientX + 14) + 'px';
      tooltip.style.top = (event.clientY - 10) + 'px';
    })
    .on('mouseleave', () => { tooltip.style.display = 'none'; });

  // ë¼ë²¨
  svg.selectAll('.district-label')
    .data(features)
    .enter()
    .append('text')
    .attr('class', 'district-label')
    .attr('x', d => pathGen.centroid(d)[0])
    .attr('y', d => pathGen.centroid(d)[1] - 2)
    .text(d => {
      const name = d.properties.name || d.properties.SIG_KOR_NM || '';
      return name.replace(/íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„/g, '').trim();
    });

  // ìˆ˜ì¹˜ ê°’ (PM2.5 ìš°ì„ , ì—†ìœ¼ë©´ PM10)
  svg.selectAll('.district-val')
    .data(features)
    .enter()
    .append('text')
    .attr('class', 'district-val')
    .attr('x', d => pathGen.centroid(d)[0])
    .attr('y', d => pathGen.centroid(d)[1] + 9)
    .text(d => {
      const name = d.properties.name || d.properties.SIG_KOR_NM || '';
      const st = matchStationToDistrict(name, stations);
      if (!st) return '';
      const val = stationMainValue(st);
      const lbl = stationMainLabel(st);
      return val ? (lbl === 'PM10' ? `${val}*` : val) : '';
    });
}

// â”€â”€â”€ ë‚´ ì§€ì—­ ë¡œë“œ â”€â”€â”€
async function loadMyRegion(lat, lng) {
  const sumContainer = document.getElementById('my-summary-container');
  const label = document.getElementById('region-label');

  const geo = await reverseGeocode(lat, lng);
  const sido = geo.sido || findNearestSido(lat, lng);
  userSido = sido;

  const regionText = geo.city ? `${geo.state} ${geo.city}` : geo.state || sido;
  label.textContent = `- ${regionText}`;
  stationAddrMap = {};

  try {
    const res = await fetch(`/api/realtime/${encodeURIComponent(sido)}`);
    const items = await res.json();
    if (!items?.length) throw new Error('ë°ì´í„° ì—†ìŒ');

    // ëª¨ë“  ì¸¡ì •ì†Œ ì‚¬ìš© (PM2.5 ì—†ì–´ë„ PM10ìœ¼ë¡œ í‘œì‹œ)
    // í–‰ì •êµ¬ì—­ ë³€ê²½ìœ¼ë¡œ ë‹¤ë¥¸ ì‹œë„ì— ì†í•œ ì¸¡ì •ì†Œ ë³´ì™„ (êµ°ìœ„êµ°â†’ëŒ€êµ¬ ë“±)
    const EXTRA_SIDO = { 'ê²½ë¶': ['ëŒ€êµ¬'] };
    if (EXTRA_SIDO[sido]) {
      for (const extra of EXTRA_SIDO[sido]) {
        try {
          const r2 = await fetch(`/api/realtime/${encodeURIComponent(extra)}`);
          const extra_items = await r2.json();
          if (Array.isArray(extra_items)) items.push(...extra_items);
        } catch(e) {}
      }
    }
    currentStations = items;

    // ëŒ€í‘œ ì¸¡ì •ì†Œ: PM2.5 ìˆëŠ” ê²ƒ > PM10 ìˆëŠ” ê²ƒ > ì•„ë¬´ê±°ë‚˜
    const rep = items.find(i => i.pm25Value && i.pm25Value !== '-')
      || items.find(i => i.pm10Value && i.pm10Value !== '-')
      || items[0];

    if (!rep) throw new Error('ì¸¡ì • ë°ì´í„° ì—†ìŒ');

    const info = stationGrade(rep);
    const mainVal = stationMainValue(rep) || '-';
    const mainLbl = stationMainLabel(rep) || 'PM2.5';

    sumContainer.innerHTML = `
      <div class="my-summary ${info.cls}">
        <div class="s-icon">&#x1F4CD;</div>
        <div class="s-info">
          <div class="s-region">${regionText}</div>
          <div class="s-station">ëŒ€í‘œ: ${rep.stationName} ì¸¡ì •ì†Œ</div>
          <div class="s-time">${rep.dataTime || ''} ì¸¡ì •</div>
        </div>
        <div class="s-grade"><div class="gv">${mainVal}</div><div class="gl">${mainLbl} ${info.label}</div></div>
        <div class="s-data">
          <div class="sd"><div class="sl">PM2.5</div><div class="sv">${vv(rep.pm25Value)}</div></div>
          <div class="sd"><div class="sl">PM10</div><div class="sv">${vv(rep.pm10Value)}</div></div>
          <div class="sd"><div class="sl">O3</div><div class="sv">${vv(rep.o3Value)}</div></div>
          <div class="sd"><div class="sl">NO2</div><div class="sv">${vv(rep.no2Value)}</div></div>
          <div class="sd"><div class="sl">CO</div><div class="sv">${vv(rep.coValue)}</div></div>
        </div>
      </div>
    `;

    // ë‚ ì”¨ ë°ì´í„° ë¡œë“œ
    try {
      const wRes = await fetch(`/api/weather?lat=${lat}&lng=${lng}`);
      const w = await wRes.json();
      if (!w.error) {
        const wc = document.getElementById('weather-container');
        const skyEmoji = {'ë§‘ìŒ':'â˜€ï¸','êµ¬ë¦„ë§ìŒ':'â›…','íë¦¼':'â˜ï¸','ë¹„':'ğŸŒ§ï¸','ëˆˆ':'ğŸŒ¨ï¸','ë¹„/ëˆˆ':'ğŸŒ§ï¸','ë¹—ë°©ìš¸':'ğŸŒ¦ï¸','ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼':'ğŸŒ¦ï¸','ëˆˆë‚ ë¦¼':'ğŸŒ¨ï¸'}[w.sky] || 'ğŸŒ¤ï¸';
        const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
        const wd = w.windDirection !== null ? dirs[Math.round(w.windDirection / 22.5) % 16] : '';
        let html = '<div class="weather-row">';
        html += `<div class="w-item"><div class="w-icon">${skyEmoji}</div><div class="w-val">${w.sky}</div><div class="w-lbl">í•˜ëŠ˜</div></div>`;
        html += `<div class="w-item"><div class="w-icon">ğŸŒ¡ï¸</div><div class="w-val">${w.temperature !== null ? w.temperature + 'Â°' : '-'}</div><div class="w-lbl">ê¸°ì˜¨</div></div>`;
        html += `<div class="w-item"><div class="w-icon">ğŸ’§</div><div class="w-val">${w.humidity !== null ? w.humidity + '%' : '-'}</div><div class="w-lbl">ìŠµë„</div></div>`;
        html += `<div class="w-item"><div class="w-icon">ğŸ’¨</div><div class="w-val">${w.windSpeed !== null ? w.windSpeed + 'm/s ' + wd : '-'}</div><div class="w-lbl">í’ì†</div></div>`;
        html += `<div class="w-item"><div class="w-icon">ğŸŒ§ï¸</div><div class="w-val">${w.precipitation || '0'}</div><div class="w-lbl">ê°•ìˆ˜(mm)</div></div>`;
        html += `<div class="w-item"><div class="w-icon">ğŸ¥¶</div><div class="w-val">${w.windChill !== null ? w.windChill + 'Â°' : '-'}</div><div class="w-lbl">ì²´ê°</div></div>`;
        if (w.uvIndex !== null) {
          html += `<div class="w-item"><div class="w-icon">â˜€ï¸</div><div class="w-val">${w.uvIndex}</div><div class="w-lbl">UV ${w.uvGrade || ''}</div></div>`;
        }
        html += `<div class="w-time">${w.baseTime || ''} ê¸°ì¤€</div>`;
        html += '</div>';
        wc.innerHTML = html;
      }
    } catch (e) { console.error('ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨:', e); }

    // ì£¼ì†Œ ê¸°ë°˜ ì¸¡ì •ì†Œâ†’í–‰ì •êµ¬ì—­ ë§¤í•‘ êµ¬ì¶• í›„ ì§€ë„ ë Œë”ë§
    if (topoData) {
      const objName = Object.keys(topoData.objects)[0];
      const allF = topojson.feature(topoData, topoData.objects[objName]).features;
      const sCode = SIDO_CODES[sido];
      const dNames = allF
        .filter(f => String(f.properties.code || '').startsWith(sCode))
        .map(f => f.properties.name || '');
      await buildStationAddrMap(sido, dNames);
      // í–‰ì •êµ¬ì—­ ë³€ê²½ìœ¼ë¡œ ë‹¤ë¥¸ ì‹œë„ ì¸¡ì •ì†Œ ì£¼ì†Œë„ ë¹Œë“œ
      const EXTRA_SIDO = { 'ê²½ë¶': ['ëŒ€êµ¬'] };
      if (EXTRA_SIDO[sido]) {
        for (const extra of EXTRA_SIDO[sido]) {
          await buildStationAddrMap(extra, dNames);
        }
      }
    }
    renderDistrictMap(sido, currentStations);
  } catch (e) {
    sumContainer.innerHTML = `<div class="my-summary gr-load" style="justify-content:center">${sido} ì§€ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }
}

// â”€â”€â”€ ë„ì‹œ ê·¸ë¦¬ë“œ â”€â”€â”€
function renderLoading() {
  document.getElementById('city-grid').innerHTML = CITIES.map(c =>
    `<div class="city-card gr-load"><div class="c-name">${c.name}</div><div class="c-station">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div><div class="c-val">--</div><div class="c-label">ë¡œë”©</div></div>`
  ).join('');
}

function renderCityCard(city, station) {
  if (!station) return `<div class="city-card gr-load"><div class="c-name">${city.name}</div><div class="c-station">ë°ì´í„° ì—†ìŒ</div><div class="c-val">--</div><div class="c-label">ì˜¤ë¥˜</div></div>`;
  const pm25 = vv(station.pm25Value);
  const info = station.pm25Grade ? gradeInfo(station.pm25Grade) : pm25ToGrade(pm25);
  return `
    <div class="city-card ${info.cls}">
      <div class="c-name">${city.name}</div>
      <div class="c-station">${station.stationName} (${station.dataTime||''})</div>
      <div class="c-val">${pm25}</div>
      <div class="c-label">PM2.5 ${info.label}</div>
      <div class="c-data">
        <span><span class="lb">PM10</span>${vv(station.pm10Value)}</span>
        <span><span class="lb">CAI</span>${vv(station.khaiValue)}</span>
        <span><span class="lb">O3</span>${vv(station.o3Value)}</span>
      </div>
    </div>`;
}

async function loadAllData() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  renderLoading();
  try {
    const bulkData = await fetchBulkSido(CITIES.map(c => c.sido));
    document.getElementById('city-grid').innerHTML = CITIES.map(city =>
      renderCityCard(city, pickStation(bulkData[city.sido]||[], city.filter))
    ).join('');
  } catch(e) { console.error('ë„ì‹œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e); }

  document.getElementById('update-time').textContent =
    new Date().toLocaleString('ko-KR',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}) + ' ê¸°ì¤€';
  btn.classList.remove('spinning');
}

// â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€
async function init() {
  // 1. ì§€ë„ ë°ì´í„° ë¡œë“œ
  try {
    const res = await fetch('/api/geodata');
    if (res.ok) topoData = await res.json();
  } catch(e) { console.error('ì§€ë„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e); }

  // 2. ìœ„ì¹˜ ìš”ì²­
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => loadMyRegion(pos.coords.latitude, pos.coords.longitude),
      () => {
        document.getElementById('my-summary-container').innerHTML =
          '<div class="my-summary gr-load" style="justify-content:center">ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì–´ ì„œìš¸ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</div>';
        document.getElementById('region-label').textContent = '- ì„œìš¸';
        loadMyRegion(37.5665, 126.9780);
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  } else {
    loadMyRegion(37.5665, 126.9780);
  }

  // 3. ë„ì‹œ ë°ì´í„°
  loadAllData();
  setInterval(() => { loadAllData(); }, REFRESH_INTERVAL);
}

document.getElementById('refresh-btn').addEventListener('click', () => {
  loadAllData();
  if (userSido) {
    navigator.geolocation?.getCurrentPosition(
      pos => loadMyRegion(pos.coords.latitude, pos.coords.longitude),
      () => loadMyRegion(37.5665, 126.9780)
    );
  }
});

init();

// â”€â”€â”€ F1 ë”ë¸”í´ë¦­ ì§€ì—­ ì„ íƒ â”€â”€â”€
(function() {
  const overlay = document.getElementById('region-overlay');
  const grid = document.getElementById('region-grid');
  let lastF1 = 0;

  // ë²„íŠ¼ ìƒì„±
  SIDO_CENTERS.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'region-btn';
    btn.textContent = s.name;
    btn.addEventListener('click', () => {
      // í™œì„± í‘œì‹œ
      grid.querySelectorAll('.region-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // í•´ë‹¹ ì§€ì—­ìœ¼ë¡œ ì „í™˜
      document.getElementById('region-label').textContent = `- ${s.name} (ìˆ˜ë™)`;
      loadMyRegion(s.lat, s.lng);
      loadAllData();
      // ë‹«ê¸°
      overlay.classList.remove('open');
    });
    grid.appendChild(btn);
  });

  // F1 ë”ë¸”í´ë¦­ ê°ì§€
  document.addEventListener('keydown', e => {
    if (e.key === 'F1') {
      e.preventDefault();
      const now = Date.now();
      if (now - lastF1 < 500) {
        // í˜„ì¬ ì§€ì—­ í™œì„± í‘œì‹œ
        grid.querySelectorAll('.region-btn').forEach(b => {
          b.classList.toggle('active', b.textContent === userSido);
        });
        overlay.classList.add('open');
        lastF1 = 0;
      } else {
        lastF1 = now;
      }
    }
    if (e.key === 'Escape') {
      overlay.classList.remove('open');
    }
  });

  // ì˜¤ë²„ë ˆì´ ë°”ê¹¥ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });

  document.getElementById('region-close-btn').addEventListener('click', () => {
    overlay.classList.remove('open');
  });
})();
</script>
</body>
</html>
