<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•œêµ­ ë¯¸ì„¸ë¨¼ì§€ ì‹¤ì‹œê°„ í˜„í™©</title>
  <meta name="google-adsense-account" content="ca-pub-2601124884291683">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2601124884291683" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #e0e0e0;
    }

    .container { max-width: 960px; margin: 0 auto; }

    header { text-align: center; margin-bottom: 36px; }

    header h1 {
      font-size: 2.2rem;
      color: #fff;
      margin-bottom: 8px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    header .subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 0.95rem;
    }

    .status-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .status-bar .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .badge-live {
      background: rgba(76, 175, 80, 0.2);
      color: #81c784;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .badge-live .dot {
      width: 8px; height: 8px;
      background: #4caf50;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .badge-time {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.15);
    }

    .badge-refresh {
      background: rgba(100, 181, 246, 0.15);
      color: #90caf9;
      border: 1px solid rgba(100, 181, 246, 0.25);
      cursor: pointer;
      transition: all 0.2s;
    }

    .badge-refresh:hover {
      background: rgba(100, 181, 246, 0.3);
    }

    .badge-refresh.spinning .refresh-icon {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .card {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 28px 32px;
      margin-bottom: 20px;
    }

    .card h2 {
      font-size: 1.15rem;
      margin-bottom: 20px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ì§€ë„ */
    #map {
      width: 100%;
      height: 450px;
      border-radius: 12px;
      z-index: 1;
    }

    .map-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 450px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.5);
      font-size: 0.95rem;
    }

    .map-loading .spinner {
      width: 24px; height: 24px;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: #90caf9;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 10px;
    }

    /* ë‚´ ìœ„ì¹˜ ì •ë³´ ë°” */
    .my-location-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
      padding: 16px 20px;
      border-radius: 12px;
      flex-wrap: wrap;
    }

    .my-location-bar .loc-icon {
      width: 48px; height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .my-location-bar .loc-info { flex: 1; min-width: 150px; }
    .my-location-bar .loc-info .loc-name { font-weight: 700; font-size: 1.05rem; }
    .my-location-bar .loc-info .loc-station { font-size: 0.75rem; opacity: 0.7; margin-top: 2px; }

    .my-location-bar .loc-aqi {
      text-align: center;
      min-width: 80px;
    }

    .my-location-bar .loc-aqi .aqi-num {
      font-size: 2.2rem;
      font-weight: 800;
      line-height: 1;
    }

    .my-location-bar .loc-aqi .aqi-lbl {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 4px;
    }

    .my-location-bar .loc-pollutants {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
    }

    .my-location-bar .loc-pollutants .p-item {
      text-align: center;
    }

    .my-location-bar .loc-pollutants .p-label {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .my-location-bar .loc-pollutants .p-val {
      font-size: 1.1rem;
      font-weight: 700;
      margin-top: 2px;
    }

    /* AQI ë§ˆì»¤ */
    .aqi-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px; height: 36px;
      border-radius: 50%;
      color: #fff;
      font-weight: 800;
      font-size: 0.7rem;
      font-family: 'Segoe UI', sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      border: 2px solid rgba(255,255,255,0.8);
      cursor: pointer;
    }

    .my-marker {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: #4285f4;
      border: 3px solid #fff;
      box-shadow: 0 0 0 6px rgba(66,133,244,0.3), 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Leaflet íŒì—… ì»¤ìŠ¤í…€ */
    .leaflet-popup-content-wrapper {
      background: #1e293b;
      color: #e0e0e0;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .leaflet-popup-tip { background: #1e293b; }
    .leaflet-popup-content {
      margin: 14px 16px;
      font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
      font-size: 0.85rem;
      line-height: 1.6;
    }
    .leaflet-popup-content strong { color: #fff; }
    .popup-aqi {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 10px;
      font-weight: 700;
      color: #fff;
      font-size: 0.8rem;
      margin-left: 4px;
    }

    /* ë„ì‹œ ê·¸ë¦¬ë“œ */
    .city-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 14px;
    }

    .city-card {
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      overflow: hidden;
    }

    .city-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .city-card .city-name { font-size: 1rem; font-weight: 700; margin-bottom: 2px; }
    .city-card .station { font-size: 0.7rem; opacity: 0.6; margin-bottom: 10px; }
    .city-card .aqi-value { font-size: 2.4rem; font-weight: 800; line-height: 1; margin-bottom: 6px; }
    .city-card .aqi-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 10px; }

    .city-card .pollutants {
      display: flex;
      justify-content: center;
      gap: 12px;
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .city-card .pollutants span {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .city-card .pollutants .label {
      font-weight: 600;
      font-size: 0.65rem;
      text-transform: uppercase;
    }

    /* AQI ë“±ê¸‰ë³„ ìƒ‰ìƒ */
    .aqi-good { background: linear-gradient(135deg, #1b5e20, #2e7d32); color: #c8e6c9; }
    .aqi-good .aqi-value, .aqi-good .city-name { color: #e8f5e9; }

    .aqi-moderate { background: linear-gradient(135deg, #e65100, #f57c00); color: #fff3e0; }
    .aqi-moderate .aqi-value, .aqi-moderate .city-name { color: #fff8e1; }

    .aqi-unhealthy-sg { background: linear-gradient(135deg, #e65100, #bf360c); color: #fbe9e7; }
    .aqi-unhealthy-sg .aqi-value, .aqi-unhealthy-sg .city-name { color: #fbe9e7; }

    .aqi-unhealthy { background: linear-gradient(135deg, #b71c1c, #c62828); color: #ffcdd2; }
    .aqi-unhealthy .aqi-value, .aqi-unhealthy .city-name { color: #ffebee; }

    .aqi-very-unhealthy { background: linear-gradient(135deg, #4a148c, #6a1b9a); color: #e1bee7; }
    .aqi-very-unhealthy .aqi-value, .aqi-very-unhealthy .city-name { color: #f3e5f5; }

    .aqi-hazardous { background: linear-gradient(135deg, #880e4f, #ad1457); color: #f8bbd0; }
    .aqi-hazardous .aqi-value, .aqi-hazardous .city-name { color: #fce4ec; }

    .aqi-loading { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.4); }

    /* ë“±ê¸‰ í…Œì´ë¸” */
    .grade-table { width: 100%; border-collapse: collapse; }
    .grade-table th, .grade-table td {
      padding: 12px 16px;
      text-align: center;
      font-size: 0.85rem;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .grade-table th {
      color: rgba(255,255,255,0.5);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .grade-dot {
      display: inline-block;
      width: 12px; height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }

    .dot-good { background: #4caf50; }
    .dot-moderate { background: #ff9800; }
    .dot-usg { background: #ff5722; }
    .dot-unhealthy { background: #f44336; }
    .dot-very { background: #9c27b0; }
    .dot-hazardous { background: #e91e63; }

    /* ë§í¬ */
    .links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .links a {
      display: block;
      padding: 14px 20px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      text-decoration: none;
      color: #ccc;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .links a:hover {
      background: rgba(102, 126, 234, 0.3);
      border-color: rgba(102, 126, 234, 0.5);
      color: #fff;
      transform: translateY(-2px);
    }

    .links a small {
      display: block;
      font-size: 0.72rem;
      font-weight: 400;
      opacity: 0.6;
      margin-top: 4px;
    }

    footer {
      text-align: center;
      margin-top: 32px;
      color: rgba(255,255,255,0.4);
      font-size: 0.75rem;
      line-height: 1.8;
    }

    footer a { color: rgba(255,255,255,0.5); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .city-card { animation: fadeIn 0.4s ease-out; }

    /* ê´‘ê³  */
    .ad-container {
      margin: 20px 0;
      text-align: center;
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      overflow: hidden;
    }

    .ad-container ins {
      width: 100%;
    }

    /* ë‚ ì”¨ ì¹´ë“œ */
    .weather-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 12px;
    }
    .weather-item {
      text-align: center;
      padding: 14px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .weather-icon { font-size: 1.5rem; margin-bottom: 6px; }
    .weather-value { font-size: 1.2rem; font-weight: 700; color: #fff; }
    .weather-label { font-size: 0.7rem; opacity: 0.6; margin-top: 4px; }
    .weather-time { font-size: 0.7rem; opacity: 0.5; margin-top: 10px; text-align: right; }

    @media (max-width: 480px) {
      body { padding: 20px 12px; }
      .card { padding: 20px 16px; }
      header h1 { font-size: 1.6rem; }
      #map { height: 350px; }
      .city-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .city-card { padding: 14px 10px; }
      .city-card .aqi-value { font-size: 1.8rem; }
      .my-location-bar { flex-direction: column; text-align: center; }
      .my-location-bar .loc-pollutants { justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>í•œêµ­ ë¯¸ì„¸ë¨¼ì§€ ì‹¤ì‹œê°„ í˜„í™©</h1>
      <p class="subtitle">ì£¼ìš” ë„ì‹œ ëŒ€ê¸°ì§ˆ ì§€ìˆ˜ (AQI) ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</p>
      <div class="status-bar">
        <span class="badge badge-live"><span class="dot"></span> ì‹¤ì‹œê°„</span>
        <span class="badge badge-time" id="update-time">ì—…ë°ì´íŠ¸ ì¤‘...</span>
        <span class="badge badge-refresh" id="refresh-btn" title="ìƒˆë¡œê³ ì¹¨">
          <span class="refresh-icon">&#x21bb;</span> ìƒˆë¡œê³ ì¹¨
        </span>
      </div>
    </header>

    <!-- ë‚´ ìœ„ì¹˜ ì§€ë„ -->
    <div class="card" id="map-card">
      <h2>&#x1F4CD; ë‚´ ì£¼ë³€ ëŒ€ê¸°ì§ˆ ì§€ë„</h2>
      <div id="my-location-container"></div>
      <div id="map-container">
        <div class="map-loading" id="map-loading">
          <div class="spinner"></div>
          ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...
        </div>
      </div>
    </div>

    <!-- ë‚ ì”¨ ì •ë³´ -->
    <div class="card" id="weather-card" style="display:none">
      <h2>&#x1F324; ë‚´ ìœ„ì¹˜ ë‚ ì”¨ <span style="font-size:0.7rem;font-weight:400;opacity:0.5" id="weather-time"></span></h2>
      <div class="weather-grid" id="weather-grid"></div>
    </div>

    <!-- ì£¼ìš” ë„ì‹œ -->
    <div class="card">
      <h2>ì£¼ìš” ë„ì‹œ ëŒ€ê¸°ì§ˆ</h2>
      <div class="city-grid" id="city-grid"></div>
    </div>

    <!-- ë“±ê¸‰ ì•ˆë‚´ -->
    <div class="card">
      <h2>ëŒ€ê¸°ì§ˆ ì§€ìˆ˜ (AQI) ë“±ê¸‰ ì•ˆë‚´</h2>
      <table class="grade-table">
        <thead>
          <tr>
            <th>ë“±ê¸‰</th>
            <th>AQI</th>
            <th>PM2.5 (&#13197;/&#13221;)</th>
            <th>í–‰ë™ ìš”ë ¹</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="grade-dot dot-good"></span>ì¢‹ìŒ</td>
            <td>0 ~ 50</td><td>0 ~ 15</td><td>ì•¼ì™¸í™œë™ ì í•©</td>
          </tr>
          <tr>
            <td><span class="grade-dot dot-moderate"></span>ë³´í†µ</td>
            <td>51 ~ 100</td><td>16 ~ 35</td><td>ë¯¼ê°êµ° ì£¼ì˜</td>
          </tr>
          <tr>
            <td><span class="grade-dot dot-usg"></span>ë¯¼ê°êµ° ë‚˜ì¨</td>
            <td>101 ~ 150</td><td>36 ~ 75</td><td>ë¯¼ê°êµ° ì•¼ì™¸í™œë™ ìì œ</td>
          </tr>
          <tr>
            <td><span class="grade-dot dot-unhealthy"></span>ë‚˜ì¨</td>
            <td>151 ~ 200</td><td>76 ~ 150</td><td>ì•¼ì™¸í™œë™ ìì œ</td>
          </tr>
          <tr>
            <td><span class="grade-dot dot-very"></span>ë§¤ìš° ë‚˜ì¨</td>
            <td>201 ~ 300</td><td>151 ~ 250</td><td>ì™¸ì¶œ ìì œ, ë§ˆìŠ¤í¬ ì°©ìš©</td>
          </tr>
          <tr>
            <td><span class="grade-dot dot-hazardous"></span>ìœ„í—˜</td>
            <td>301+</td><td>251+</td><td>ì‹¤ì™¸í™œë™ ê¸ˆì§€</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ì°¸ê³  ì‚¬ì´íŠ¸ -->
    <div class="card">
      <h2>ì°¸ê³  ì‚¬ì´íŠ¸</h2>
      <div class="links">
        <a href="https://www.airkorea.or.kr/web/" target="_blank" rel="noopener">
          ì—ì–´ì½”ë¦¬ì•„<small>í™˜ê²½ë¶€ ì‹¤ì‹œê°„ ëŒ€ê¸°ì§ˆ</small>
        </a>
        <a href="https://cleanair.seoul.go.kr/" target="_blank" rel="noopener">
          ì„œìš¸ì‹œ ëŒ€ê¸°í™˜ê²½ì •ë³´<small>ì„œìš¸ ì§€ì—­ ìƒì„¸ ë°ì´í„°</small>
        </a>
        <a href="https://aqicn.org/map/south-korea/kr/" target="_blank" rel="noopener">
          WAQI í•œêµ­ ì§€ë„<small>ì „êµ­ ì‹¤ì‹œê°„ AQI ì§€ë„</small>
        </a>
        <a href="https://www.airkorea.or.kr/web/dustForecast" target="_blank" rel="noopener">
          ëŒ€ê¸°ì§ˆ ì˜ˆë³´<small>ì˜¤ëŠ˜/ë‚´ì¼/ëª¨ë ˆ ì˜ˆë³´</small>
        </a>
      </div>
    </div>

    <!-- í•˜ë‹¨ ê´‘ê³  -->
    <div class="ad-container">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-2601124884291683"
           data-ad-slot="auto"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <footer>
      <p>ë°ì´í„° ì¶œì²˜: <a href="https://waqi.info/" target="_blank" rel="noopener">World Air Quality Index (WAQI)</a></p>
      <p>30ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹  | ë°ì´í„°ëŠ” ì‹¤ì œ ê´€ì¸¡ê°’ê³¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </footer>
  </div>

  <script>
    // â”€â”€â”€ ê³µí†µ ì„¤ì • â”€â”€â”€
    const WAQI_TOKEN = 'demo';
    const REFRESH_INTERVAL = 30 * 60 * 1000;
    let map = null;
    let markerLayer = null;
    let userLat = null, userLng = null;

    const CITIES = [
      { id: 'seoul',    name: 'ì„œìš¸',  feed: 'seoul' },
      { id: 'busan',    name: 'ë¶€ì‚°',  feed: 'busan' },
      { id: 'incheon',  name: 'ì¸ì²œ',  feed: 'incheon' },
      { id: 'daegu',    name: 'ëŒ€êµ¬',  feed: 'daegu' },
      { id: 'daejeon',  name: 'ëŒ€ì „',  feed: 'daejeon' },
      { id: 'gwangju',  name: 'ê´‘ì£¼',  feed: 'gwangju' },
      { id: 'ulsan',    name: 'ìš¸ì‚°',  feed: 'ulsan' },
      { id: 'sejong',   name: 'ì„¸ì¢…',  feed: 'sejong' },
      { id: 'suwon',    name: 'ìˆ˜ì›',  feed: 'suwon' },
      { id: 'jeju',     name: 'ì œì£¼',  feed: 'jeju' },
      { id: 'changwon', name: 'ì°½ì›',  feed: 'changwon' },
      { id: 'cheongju', name: 'ì²­ì£¼',  feed: 'cheongju' },
    ];

    // â”€â”€â”€ AQI ìœ í‹¸ â”€â”€â”€
    function getAqiInfo(aqi) {
      if (aqi <= 50)  return { label: 'ì¢‹ìŒ',      cls: 'aqi-good',           color: '#4caf50' };
      if (aqi <= 100) return { label: 'ë³´í†µ',      cls: 'aqi-moderate',       color: '#ff9800' };
      if (aqi <= 150) return { label: 'ë¯¼ê°êµ° ë‚˜ì¨', cls: 'aqi-unhealthy-sg',  color: '#ff5722' };
      if (aqi <= 200) return { label: 'ë‚˜ì¨',      cls: 'aqi-unhealthy',      color: '#f44336' };
      if (aqi <= 300) return { label: 'ë§¤ìš° ë‚˜ì¨',  cls: 'aqi-very-unhealthy', color: '#9c27b0' };
      return               { label: 'ìœ„í—˜',      cls: 'aqi-hazardous',      color: '#e91e63' };
    }

    function getAqiColor(aqi) {
      return getAqiInfo(aqi).color;
    }

    // â”€â”€â”€ ì§€ë„ ì´ˆê¸°í™” â”€â”€â”€
    function initMap(lat, lng) {
      const container = document.getElementById('map-container');
      container.innerHTML = '<div id="map"></div>';

      map = L.map('map', {
        center: [lat, lng],
        zoom: 11,
        zoomControl: true,
      });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
        maxZoom: 18,
      }).addTo(map);

      // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
      const myIcon = L.divIcon({
        className: '',
        html: '<div class="my-marker"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10],
      });

      L.marker([lat, lng], { icon: myIcon, zIndexOffset: 1000 })
        .addTo(map)
        .bindPopup('<strong>ë‚´ ìœ„ì¹˜</strong>');

      markerLayer = L.layerGroup().addTo(map);

      // ì§€ë„ ì´ë™ ì‹œ ì£¼ë³€ ê´€ì¸¡ì†Œ ê°±ì‹ 
      map.on('moveend', loadMapStations);
    }

    // â”€â”€â”€ AQI ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„± â”€â”€â”€
    function createAqiIcon(aqi) {
      const color = getAqiColor(aqi);
      return L.divIcon({
        className: '',
        html: `<div class="aqi-marker" style="background:${color};">${aqi}</div>`,
        iconSize: [36, 36],
        iconAnchor: [18, 18],
      });
    }

    // â”€â”€â”€ ì§€ë„ ì£¼ë³€ ê´€ì¸¡ì†Œ ë¡œë“œ â”€â”€â”€
    async function loadMapStations() {
      if (!map) return;
      const bounds = map.getBounds();
      const lat1 = bounds.getSouth();
      const lng1 = bounds.getWest();
      const lat2 = bounds.getNorth();
      const lng2 = bounds.getEast();

      try {
        const res = await fetch(
          `https://api.waqi.info/v2/map/bounds/?latlng=${lat1},${lng1},${lat2},${lng2}&networks=all&token=${WAQI_TOKEN}`
        );
        const json = await res.json();
        if (json.status !== 'ok') return;

        markerLayer.clearLayers();

        json.data.forEach(station => {
          const aqi = station.aqi;
          if (aqi === '-' || isNaN(aqi)) return;

          const marker = L.marker([station.lat, station.lon], {
            icon: createAqiIcon(parseInt(aqi)),
          });

          const info = getAqiInfo(parseInt(aqi));
          const name = station.station?.name || 'ê´€ì¸¡ì†Œ';
          marker.bindPopup(`
            <strong>${name}</strong><br>
            AQI: <span class="popup-aqi" style="background:${info.color}">${aqi} ${info.label}</span>
          `);

          markerLayer.addLayer(marker);
        });
      } catch (e) {
        console.error('ê´€ì¸¡ì†Œ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    // â”€â”€â”€ ë‚´ ìœ„ì¹˜ ê·¼ì²˜ AQI ì •ë³´ í‘œì‹œ â”€â”€â”€
    async function loadMyLocationAqi(lat, lng) {
      const container = document.getElementById('my-location-container');
      try {
        const res = await fetch(
          `https://api.waqi.info/feed/geo:${lat};${lng}/?token=${WAQI_TOKEN}`
        );
        const json = await res.json();
        if (json.status !== 'ok') throw new Error(json.data);

        const d = json.data;
        const aqi = d.aqi;
        const info = getAqiInfo(aqi);
        const iaqi = d.iaqi || {};
        const pm25 = iaqi.pm25 ? iaqi.pm25.v : '-';
        const pm10 = iaqi.pm10 ? iaqi.pm10.v : '-';
        const o3   = iaqi.o3   ? iaqi.o3.v   : '-';
        const no2  = iaqi.no2  ? iaqi.no2.v  : '-';
        const stationName = d.city?.name || 'ë‚´ ì£¼ë³€ ê´€ì¸¡ì†Œ';

        container.innerHTML = `
          <div class="my-location-bar ${info.cls}">
            <div class="loc-icon" style="background:rgba(255,255,255,0.15);">&#x1F4CD;</div>
            <div class="loc-info">
              <div class="loc-name">ë‚´ ìœ„ì¹˜ ëŒ€ê¸°ì§ˆ</div>
              <div class="loc-station">${stationName}</div>
            </div>
            <div class="loc-aqi">
              <div class="aqi-num">${aqi}</div>
              <div class="aqi-lbl">${info.label}</div>
            </div>
            <div class="loc-pollutants">
              <div class="p-item"><div class="p-label">PM2.5</div><div class="p-val">${pm25}</div></div>
              <div class="p-item"><div class="p-label">PM10</div><div class="p-val">${pm10}</div></div>
              <div class="p-item"><div class="p-label">O3</div><div class="p-val">${o3}</div></div>
              <div class="p-item"><div class="p-label">NO2</div><div class="p-val">${no2}</div></div>
            </div>
          </div>
        `;
      } catch (e) {
        container.innerHTML = `
          <div class="my-location-bar aqi-loading" style="justify-content:center;">
            ì£¼ë³€ ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `;
      }
    }

    // â”€â”€â”€ ë‚ ì”¨ ë¡œë“œ â”€â”€â”€
    async function loadWeather(lat, lng) {
      try {
        const res = await fetch(`/api/weather?lat=${lat}&lng=${lng}`);
        const w = await res.json();
        if (w.error) throw new Error(w.error);

        const card = document.getElementById('weather-card');
        const grid = document.getElementById('weather-grid');
        card.style.display = '';

        const skyEmoji = {'ë§‘ìŒ':'â˜€ï¸','êµ¬ë¦„ë§ìŒ':'â›…','íë¦¼':'â˜ï¸','ë¹„':'ğŸŒ§ï¸','ëˆˆ':'ğŸŒ¨ï¸','ë¹„/ëˆˆ':'ğŸŒ§ï¸','ë¹—ë°©ìš¸':'ğŸŒ¦ï¸','ë¹—ë°©ìš¸ëˆˆë‚ ë¦¼':'ğŸŒ¦ï¸','ëˆˆë‚ ë¦¼':'ğŸŒ¨ï¸'}[w.sky] || 'ğŸŒ¤ï¸';
        const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
        const windDir = w.windDirection !== null ? dirs[Math.round(w.windDirection / 22.5) % 16] : '';

        let items = [
          { icon: skyEmoji, value: w.sky, label: 'í•˜ëŠ˜ìƒíƒœ' },
          { icon: 'ğŸŒ¡ï¸', value: w.temperature !== null ? w.temperature + 'Â°' : '-', label: 'ê¸°ì˜¨' },
          { icon: 'ğŸ’§', value: w.humidity !== null ? w.humidity + '%' : '-', label: 'ìŠµë„' },
          { icon: 'ğŸ’¨', value: w.windSpeed !== null ? w.windSpeed + 'm/s ' + windDir : '-', label: 'í’ì†/í’í–¥' },
          { icon: 'ğŸŒ§ï¸', value: w.precipitation || '0', label: 'ê°•ìˆ˜ëŸ‰(mm)' },
          { icon: 'ğŸ¥¶', value: w.windChill !== null ? w.windChill + 'Â°' : '-', label: 'ì²´ê°ì˜¨ë„' },
        ];
        if (w.uvIndex !== null) {
          items.push({ icon: 'â˜€ï¸', value: w.uvIndex + ' ' + (w.uvGrade || ''), label: 'ìì™¸ì„ ì§€ìˆ˜' });
        }

        grid.innerHTML = items.map(item => `
          <div class="weather-item">
            <div class="weather-icon">${item.icon}</div>
            <div class="weather-value">${item.value}</div>
            <div class="weather-label">${item.label}</div>
          </div>
        `).join('');

        const timeEl = document.getElementById('weather-time');
        if (timeEl) timeEl.textContent = w.baseTime + ' ê¸°ì¤€';
      } catch (e) {
        console.error('ë‚ ì”¨ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    // â”€â”€â”€ ìœ„ì¹˜ ìš”ì²­ â”€â”€â”€
    function requestLocation() {
      if (!navigator.geolocation) {
        showMapFallback('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          initMap(userLat, userLng);
          loadMapStations();
          loadMyLocationAqi(userLat, userLng);
          loadWeather(userLat, userLng);
        },
        (err) => {
          // ìœ„ì¹˜ ê±°ë¶€ ì‹œ ì„œìš¸ ì¤‘ì‹¬ìœ¼ë¡œ í‘œì‹œ
          showMapFallback(null);
          userLat = 37.5665;
          userLng = 126.9780;
          initMap(userLat, userLng);
          loadMapStations();
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function showMapFallback(msg) {
      const container = document.getElementById('my-location-container');
      if (msg) {
        container.innerHTML = `
          <div class="my-location-bar aqi-loading" style="justify-content:center;">
            ${msg}
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="my-location-bar aqi-loading" style="justify-content:center;">
            ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì–´ ì„œìš¸ ì¤‘ì‹¬ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
          </div>
        `;
      }
    }

    // â”€â”€â”€ ë„ì‹œ ê·¸ë¦¬ë“œ â”€â”€â”€
    function renderLoadingCards() {
      const grid = document.getElementById('city-grid');
      grid.innerHTML = CITIES.map(city => `
        <div class="city-card aqi-loading">
          <div class="city-name">${city.name}</div>
          <div class="station">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          <div class="aqi-value">--</div>
          <div class="aqi-label">ë¡œë”©</div>
        </div>
      `).join('');
    }

    async function fetchCityAqi(city) {
      try {
        const res = await fetch(
          `https://api.waqi.info/feed/${city.feed}/?token=${WAQI_TOKEN}`
        );
        const json = await res.json();
        if (json.status !== 'ok') throw new Error(json.data);
        return { city, data: json.data };
      } catch (err) {
        return { city, error: err.message };
      }
    }

    function renderCityCard(result) {
      if (result.error) {
        return `
          <div class="city-card aqi-loading">
            <div class="city-name">${result.city.name}</div>
            <div class="station">ë°ì´í„° ì—†ìŒ</div>
            <div class="aqi-value">--</div>
            <div class="aqi-label">ì˜¤ë¥˜</div>
          </div>
        `;
      }

      const { data } = result;
      const aqi = data.aqi;
      const info = getAqiInfo(aqi);
      const iaqi = data.iaqi || {};
      const pm25 = iaqi.pm25 ? iaqi.pm25.v : '-';
      const pm10 = iaqi.pm10 ? iaqi.pm10.v : '-';
      const stationName = data.city?.name || '';

      return `
        <div class="city-card ${info.cls}" style="animation-delay: ${Math.random() * 0.3}s">
          <div class="city-name">${result.city.name}</div>
          <div class="station">${stationName}</div>
          <div class="aqi-value">${aqi}</div>
          <div class="aqi-label">${info.label}</div>
          <div class="pollutants">
            <span><span class="label">PM2.5</span>${pm25}</span>
            <span><span class="label">PM10</span>${pm10}</span>
          </div>
        </div>
      `;
    }

    // â”€â”€â”€ ì „ì²´ ë°ì´í„° ë¡œë“œ â”€â”€â”€
    async function loadAllData() {
      const refreshBtn = document.getElementById('refresh-btn');
      refreshBtn.classList.add('spinning');
      renderLoadingCards();

      // ë„ì‹œ ë°ì´í„°
      const results = await Promise.all(CITIES.map(fetchCityAqi));
      document.getElementById('city-grid').innerHTML = results.map(renderCityCard).join('');

      // ì§€ë„ & ë‚ ì”¨ ê°±ì‹ 
      if (map) {
        loadMapStations();
        if (userLat && userLng) {
          loadMyLocationAqi(userLat, userLng);
          loadWeather(userLat, userLng);
        }
      }

      // ì‹œê°„ ê°±ì‹ 
      const now = new Date();
      const timeStr = now.toLocaleString('ko-KR', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
      });
      document.getElementById('update-time').textContent = timeStr + ' ê¸°ì¤€';
      refreshBtn.classList.remove('spinning');
    }

    // â”€â”€â”€ ì‹œì‘ â”€â”€â”€
    requestLocation();
    loadAllData();
    setInterval(loadAllData, REFRESH_INTERVAL);
    document.getElementById('refresh-btn').addEventListener('click', loadAllData);
  </script>
</body>
</html>
